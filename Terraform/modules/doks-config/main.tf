terraform {
  required_providers {
    digitalocean = {
      source  = "digitalocean/digitalocean"
      version = ">= 2.4.0"
    }
    kubernetes = {
      source = "hashicorp/kubernetes"
      version = ">= 2.0.0"
    }
  }
}

# ğŸ‡µâ€‹â€‹â€‹â€‹â€‹ğŸ‡·â€‹â€‹â€‹â€‹â€‹ğŸ‡´â€‹â€‹â€‹â€‹â€‹ğŸ‡»â€‹â€‹â€‹â€‹â€‹ğŸ‡®â€‹â€‹â€‹â€‹â€‹ğŸ‡©â€‹â€‹â€‹â€‹â€‹ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ğŸ‡·â€‹â€‹â€‹â€‹â€‹ğŸ‡¸â€‹â€‹â€‹â€‹â€‹
provider "kubernetes" {
  host = var.cluster_host
  token = var.cluster_token
  cluster_ca_certificate = var.cluster_certificate
}


# ğŸ‡°â€‹â€‹â€‹â€‹â€‹ğŸ‡ºâ€‹â€‹â€‹â€‹â€‹ğŸ‡§â€‹â€‹â€‹â€‹â€‹ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ğŸ‡´â€‹â€‹â€‹â€‹â€‹ğŸ‡³â€‹â€‹â€‹â€‹â€‹ğŸ‡«â€‹â€‹â€‹â€‹â€‹
resource "local_file" "kubeconfig" {
  depends_on = [var.cluster_id]
  content    = var.kubeconfig
  filename   = "./kubeconfig"

  provisioner "local-exec" {
    command = <<-EOT
      doctl kubernetes cluster kubeconfig save $CLUSTERID
      kubectl apply -f 'https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml'
    EOT
      
    interpreter = ["/bin/sh", "-c"]
    environment = {
      CLUSTERID = var.cluster_id
    }
  }
}


# ğŸ‡³â€‹â€‹â€‹â€‹â€‹ğŸ‡¦â€‹â€‹â€‹â€‹â€‹ğŸ‡²â€‹â€‹â€‹â€‹â€‹ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ğŸ‡¸â€‹â€‹â€‹â€‹â€‹ğŸ‡µâ€‹â€‹â€‹â€‹â€‹ğŸ‡¦â€‹â€‹â€‹â€‹â€‹ğŸ‡¨â€‹â€‹â€‹â€‹â€‹ğŸ‡ªâ€‹â€‹â€‹â€‹â€‹ğŸ‡¸â€‹â€‹â€‹â€‹â€‹
resource "kubernetes_namespace" "test" {
  metadata {
    name = "test"
  }
}

resource "kubernetes_namespace" "production" {
  metadata {
    name = "production"
  }
}